# Populate the Endless Key home directory

if [ -z "${EIB_ENDLESSKEY_COLLECTIONS}" ]; then
  exit 0
fi

if [[ ! "${EIB_FLATPAK_REMOTE_FLATHUB_APPS}" =~ .*"org.endlessos.Key".* ]]; then
  exit 0
fi

# Get the list of channels to preload.
channels_file="${EIB_TMPDIR}"/ek-channels
rm -f "${channels_file}"
touch "${channels_file}"
collections="${OSTREE_VAR}"/lib/flatpak/app/org.endlessos.Key/current/active/files/share/endless-key/collections/*.json
for collection in ${collections}; do
  # Check if the file basename stripped off of -0001.json is part of the list
  # of collections to be installed.
  bn=$(basename ${collection})
  if [[ "${EIB_ENDLESSKEY_COLLECTIONS}" =~ .*"${bn%-????.json}".* ]] ; then
    jq -r '.channels[].id' "${collection}" >> "${channels_file}"
  fi
done

channels=$(sort -u "${channels_file}")
if [ -z "${channels}" ]; then
  echo "No Kolibri channels to preload"
  exit 0
fi

# Seed the needed channels on the content server.
"${EIB_HELPERSDIR}"/seed-kolibri-channels ${channels}

venv_dir="${EIB_TMPDIR}/kolibri-content-venv"
python3 -m venv ${venv_dir}
source ${venv_dir}/bin/activate
pip install "${EIB_ENDLESSKEY_KOLIBRI_PKGSPEC}"

# Setup the homedir before setting any environment variables so they
# don't persist into the options file.
export KOLIBRI_HOME="${OSTREE_VAR}"/lib/endless-key/data
mkdir -p "${KOLIBRI_HOME}"
kolibri configure setup

# Use a separate content URL if configured.
if [ -n "${EIB_KOLIBRI_CENTRAL_CONTENT_BASE_URL}" ]; then
  KOLIBRI_CENTRAL_CONTENT_BASE_URL="${EIB_KOLIBRI_CENTRAL_CONTENT_BASE_URL}"
  export KOLIBRI_CENTRAL_CONTENT_BASE_URL
fi

for channel in $channels; do
  kolibri manage --skip-update importchannel network "${channel}"
  EIB_RETRY_ATTEMPTS=2 EIB_RETRY_INTERVAL=30 eib_retry \
    kolibri manage --skip-update \
    importcontent --include-unrenderable-content --fail-on-error \
    network "${channel}"
done

# Empty the user database, and ensure that each instance of this image has a
# unique Facility ID.
# <https://kolibri.readthedocs.io/en/latest/install/provision.html#prepare-the-kolibri-folder-for-copying>
(echo yes; echo yes) | kolibri manage --skip-update deprovision

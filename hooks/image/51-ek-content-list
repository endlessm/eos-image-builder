# Populate the Endless Key home directory

if [ -z "${EIB_ENDLESSKEY_COLLECTIONS}" ]; then
  exit 0
fi

if [[ ! "${EIB_FLATPAK_REMOTE_FLATHUB_APPS}" =~ .*"org.endlessos.Key".* ]]; then
  exit 0
fi

# This file is used by hooks/image/52-ek-content-cache and
# hooks/image/53-ek-content-preload
EK_CHANNELS_FILE="${EIB_TMPDIR}"/ek-channels

rm -f "${EK_CHANNELS_FILE}"
collections="${OSTREE_VAR}"/lib/flatpak/app/org.endlessos.Key/current/active/files/share/endless-key/collections/*.json
for collection in ${collections}; do
  # Check if the file basename stripped off of -0001.json is part of the list
  # of collections to be installed.
  bn=$(basename ${collection})
  if [[ "${EIB_ENDLESSKEY_COLLECTIONS}" =~ .*"${bn%-????.json}".* ]] ; then
    jq -r '.channels[].id' "${collection}" >> "${EK_CHANNELS_FILE}"
  fi
done
